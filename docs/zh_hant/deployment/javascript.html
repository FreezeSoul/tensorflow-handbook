

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>TensorFlow in JavaScript（Huan） &mdash; 简单粗暴 TensorFlow 2 0.4 beta 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/js/tw_cn.js"></script>
        <script src="../../_static/js/pangu.min.js"></script>
        <script src="../../_static/js/custom_20200921.js"></script>
        <script src="../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="TensorFlow分布式訓練" href="../appendix/distributed.html" />
    <link rel="prev" title="TensorFlow Lite（Jinpeng）" href="lite.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> 简单粗暴 TensorFlow 2
          

          
          </a>

          
            
            
              <div class="version">
                0.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">目录</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/foreword.html">推荐序</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/preface.html">前言</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/introduction.html">TensorFlow概述</a></li>
</ul>
<p class="caption"><span class="caption-text">基础</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/basic/installation.html">TensorFlow安装与环境配置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/basic/basic.html">TensorFlow基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/basic/models.html">TensorFlow 模型建立与训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/basic/tools.html">TensorFlow常用模块</a></li>
</ul>
<p class="caption"><span class="caption-text">部署</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/deployment/export.html">TensorFlow模型导出</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/deployment/serving.html">TensorFlow Serving</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/deployment/lite.html">TensorFlow Lite（Jinpeng）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/deployment/javascript.html">TensorFlow in JavaScript（Huan）</a></li>
</ul>
<p class="caption"><span class="caption-text">大规模训练与加速</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/appendix/distributed.html">TensorFlow分布式训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/appendix/tpu.html">使用TPU训练TensorFlow模型（Huan）</a></li>
</ul>
<p class="caption"><span class="caption-text">扩展</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/appendix/tfhub.html">TensorFlow Hub 模型复用（Jinpeng）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/appendix/tfds.html">TensorFlow Datasets 数据集载入</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/appendix/swift.html">Swift for TensorFlow (S4TF) (Huan）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/appendix/quantum.html">TensorFlow Quantum: 混合量子-经典机器学习 *</a></li>
</ul>
<p class="caption"><span class="caption-text">附录</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/appendix/rl.html">强化学习简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/appendix/docker.html">使用Docker部署TensorFlow环境</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/appendix/cloud.html">在云端使用TensorFlow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/appendix/jupyterlab.html">部署自己的交互式Python开发环境JupyterLab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/appendix/recommended_books.html">参考资料与推荐阅读</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zh_hans/appendix/terms.html">术语中英对照表</a></li>
</ul>
<p class="caption"><span class="caption-text">目錄</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../preface.html">前言</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">TensorFlow概述</a></li>
</ul>
<p class="caption"><span class="caption-text">基礎</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../basic/installation.html">TensorFlow 安裝與環境配置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic/basic.html">TensorFlow 基礎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic/models.html">TensorFlow 模型建立與訓練</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic/tools.html">TensorFlow常用模組</a></li>
</ul>
<p class="caption"><span class="caption-text">部署</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="export.html">TensorFlow模型匯出</a></li>
<li class="toctree-l1"><a class="reference internal" href="serving.html">TensorFlow Serving</a></li>
<li class="toctree-l1"><a class="reference internal" href="lite.html">TensorFlow Lite（Jinpeng）</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">TensorFlow in JavaScript（Huan）</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#tensorflow-js">TensorFlow.js 簡介</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">瀏覽器中使用 TensorFlow.js 的優勢</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id2">TensorFlow.js 環境配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id3">在瀏覽器中使用 TensorFlow.js</a></li>
<li class="toctree-l3"><a class="reference internal" href="#node-js-tensorflow-js">在 Node.js 中使用 TensorFlow.js</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">在微信小程式中使用 TensorFlow.js</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id7">TensorFlow.js 模型部署</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#python">在瀏覽器中加載 Python 模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="#node-js-savedmodel">在 Node.js 中執行原生 SavedModel 模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">使用 TensorFlow.js 模型資料庫</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mobilenet">在瀏覽器中使用 MobileNet 進行攝像頭物體辨識</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id11">TensorFlow.js 模型訓練 *</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id15">TensorFlow.js 性能對比</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">大規模訓練與加速</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../appendix/distributed.html">TensorFlow分布式訓練</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/tpu.html">使用TPU訓練TensorFlow模型（Huan）</a></li>
</ul>
<p class="caption"><span class="caption-text">擴展</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../appendix/tfhub.html">TensorFlow Hub 模型複用（Jinpeng）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/tfds.html">TensorFlow Datasets 資料集載入</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/swift.html">Swift for TensorFlow (S4TF) (Huan）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/quantum.html">TensorFlow Quantum: 混合量子-經典機器學習 *</a></li>
</ul>
<p class="caption"><span class="caption-text">附錄</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../appendix/rl.html">強化學習簡介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/docker.html">使用Docker部署TensorFlow環境</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/cloud.html">在雲端使用TensorFlow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/jupyterlab.html">部署自己的互動式 Python 開發環境 JupyterLab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/recommended_books.html">參考資料與推薦閱讀</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/terms.html">專有名詞中英對照表</a></li>
</ul>
<p class="caption"><span class="caption-text">Preface</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../en/preface.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../en/introduction.html">TensorFlow Overview</a></li>
</ul>
<p class="caption"><span class="caption-text">Basic</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../en/basic/installation.html">Installation and Environment Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../en/basic/basic.html">TensorFlow Basic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../en/basic/models.html">Model Construction and Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../en/basic/tools.html">Common Modules in TensorFlow</a></li>
</ul>
<p class="caption"><span class="caption-text">Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../en/deployment/export.html">TensorFlow Model Export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../en/deployment/serving.html">TensorFlow Serving</a></li>
</ul>
<p class="caption"><span class="caption-text">Large-scale Training</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../en/appendix/distributed.html">Distributed training with TensorFlow</a></li>
</ul>
<p class="caption"><span class="caption-text">Extensions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../en/appendix/tfds.html">TensorFlow Datasets: Ready-to-use Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../en/appendix/quantum.html">TensorFlow Quantum: Hybrid Quantum-classical Machine Learning *</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">简单粗暴 TensorFlow 2</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>TensorFlow in JavaScript（Huan）</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/zh_hant/deployment/javascript.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tensorflow-in-javascript-huan">
<h1>TensorFlow in JavaScript（Huan）<a class="headerlink" href="#tensorflow-in-javascript-huan" title="永久链接至标题">¶</a></h1>
<blockquote>
<div><p><strong>Atwood’s Law</strong></p>
<p>“Any application that can be written in JavaScript, will eventually be written in JavaScript.”</p>
<blockquote>
<div><p>– Jeff Atwood, Founder of StackOverflow.com</p>
</div></blockquote>
<p>“JavaScript now works.”</p>
<blockquote>
<div><p>– Paul Graham, YC Founder</p>
</div></blockquote>
</div></blockquote>
<div class="section" id="tensorflow-js">
<h2>TensorFlow.js 簡介<a class="headerlink" href="#tensorflow-js" title="永久链接至标题">¶</a></h2>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/tensorflow-js.png"><img alt="../../_images/tensorflow-js.png" src="../../_images/tensorflow-js.png" style="width: 60%;" /></a>
</div>
<p>TensorFlow.js 是 TensorFlow 的 JavaScript 版本，支持 GPU 硬體加速，可以執行在 Node.js 或瀏覽器環境中。不但支援完全基於 JavaScript 從頭開發、訓練和部署模型，也可以用來運行已有的 Python 版 TensorFlow 模型，或者基於現有的模型進行繼續訓練。</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/architecture.png"><img alt="../../_images/architecture.png" src="../../_images/architecture.png" style="width: 60%;" /></a>
</div>
<p>TensorFlow.js 支援 GPU 硬體加速。在 Node.js 環境中，如果有 CUDA 環境支援，或者在瀏覽器環境中，有 WebGL 環境支援，那麼 TensorFlow.js 可以使用硬體進行加速。</p>
<div class="admonition- admonition">
<p class="admonition-title">微信小程式</p>
<p>微信小程式也提供了官方套件，封裝了TensorFlow.js 函式庫，利用小程式WebGL API 給第三方程式呼叫時提供 GPU 加速。</p>
</div>
<p>本章，我們將基於 TensorFlow.js 1.0，向大家簡單地介紹如何基於 ES6 的 JavaScript 進行 TensorFlow.js 的開發，然後提供兩個例子，並基於例子進行詳細的講解和介紹，最終實現使用純 JavaScript 進行 TensorFlow 模型的開發、訓練和部署。</p>
<div class="admonition- admonition">
<p class="admonition-title">章節程式碼位置</p>
<p>本章中提到的 JavaScript 版 TensorFlow 的相關程式碼，使用說明，和訓練好的模型文件及參數，都可以在作者的 GitHub 上找到。地址： <a class="reference external" href="https://github.com/huan/tensorflow-handbook-javascript">https://github.com/huan/tensorflow-handbook-javascript</a></p>
</div>
<div class="section" id="id1">
<h3>瀏覽器中使用 TensorFlow.js 的優勢<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/chrome-ml.png"><img alt="../../_images/chrome-ml.png" src="../../_images/chrome-ml.png" style="width: 60%;" /></a>
</div>
<p>TensorFlow.js 可以讓我們直接在瀏覽器中載入 TensorFlow，讓用戶立即透過自己的 CPU/GPU 資源進行我們所需要的機器學習運算，更靈活地進行 AI 應用的開發。</p>
<p>瀏覽器中進行機器學習，相對比與伺服器端來講，將擁有以下四大優勢：</p>
<ul class="simple">
<li><p>不需要安裝軟體或驅動程式（打開瀏覽器即可使用）；</p></li>
<li><p>可以透過瀏覽器進行更加方便的人機互動；</p></li>
<li><p>可以透過手機瀏覽器，呼叫手機硬體的各種感測器（如：GPS、電子羅盤、加速度傳感器、相機等）；</p></li>
<li><p>用戶的資料不需要上傳到伺服器，在本機端即可完成所需操作。</p></li>
</ul>
<p>透過這些優勢，TensorFlow.js 將給開發者帶來極高的靈活性。比如在 Google Creative Lab 在 2018 年 7 月發布的 Move Mirror 裡，我們可以在手機上打開瀏覽器，通過手機攝像頭檢測影片中用戶的身體動作姿勢，然後透過對圖片資料庫中類似身體動作姿勢的檢索，給用戶顯示一個最能夠和他當前動作相似的照片。在 Move Mirror 的執行過程中，資料沒有上傳到伺服器，所有的運算都是在手機本體，基於手機的 CPU/GPU 完成的，而這項技術，將使 Servreless 與 AI 應用結合起來成為可能。</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/move-mirror.jpg"><img alt="../../_images/move-mirror.jpg" src="../../_images/move-mirror.jpg" style="width: 60%;" /></a>
</div>
<ul class="simple">
<li><p>Move Mirror 網址：<a class="reference external" href="https://experiments.withgoogle.com/move-mirror">https://experiments.withgoogle.com/move-mirror</a></p></li>
<li><p>Move Mirror 所使用的 PoseNet 網址：<a class="reference external" href="https://github.com/tensorflow/tfjs-models/tree/master/posenet">https://github.com/tensorflow/tfjs-models/tree/master/posenet</a></p></li>
</ul>
</div>
</div>
<div class="section" id="id2">
<h2>TensorFlow.js 環境配置<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<div class="section" id="id3">
<h3>在瀏覽器中使用 TensorFlow.js<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<p>在瀏覽器中載入 TensorFlow.js ，最方便的方法是在 HTML 中直接引用 TensorFlow.js 發布的 NPM 包中已經打包安裝好的 JavaScript 程式碼。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;http://unpkg.com/@tensorflow/tfjs/dist/tf.min.js&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="node-js-tensorflow-js">
<h3>在 Node.js 中使用 TensorFlow.js<a class="headerlink" href="#node-js-tensorflow-js" title="永久链接至标题">¶</a></h3>
<p>伺服器端使用 JavaScript ，首先需要按照 <a class="reference external" href="https://nodejs.org">NodeJS.org</a> 官網的說明，完成安裝最新版本的 Node.js 。</p>
<p>然後，完成以下四個步驟即可完成配置：</p>
<ol class="arabic">
<li><p>確認 Node.js 版本（v10 或更新的版本）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ node --verion
v10.5.0

$ npm --version
6.4.1
</pre></div>
</div>
</li>
<li><p>建立 TensorFlow.js 項目目錄:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mkdir tfjs
$ cd tfjs
</pre></div>
</div>
</li>
<li><p>安裝 TensorFlow.js:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># 初始化項目管理文件 package.json
$ npm init -y

# 安裝 tfjs 函式庫，純 JavaScript 版本
$ npm install @tensorflow/tfjs

# 安裝 tfjs-node 函式庫，C Binding 版本
$ npm install @tensorflow/tfjs-node

# 安裝 tfjs-node-gpu 函式庫，支援 CUDA GPU 加速
$ npm install @tensorflow/tfjs-node-gpu
</pre></div>
</div>
</li>
<li><p>確認 Node.js 和 TensorFlow.js 工作正常:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ node
&gt; require(&#39;@tensorflow/tfjs&#39;).version
{
    &#39;tfjs-core&#39;: &#39;1.3.1&#39;,
    &#39;tfjs-data&#39;: &#39;1.3.1&#39;,
    &#39;tfjs-layers&#39;: &#39;1.3.1&#39;,
    &#39;tfjs-converter&#39;: &#39;1.3.1&#39;,
    tfjs: &#39;1.3.1&#39;
}
&gt;
</pre></div>
</div>
</li>
</ol>
<p>如果你看到了上面的 <code class="docutils literal notranslate"><span class="pre">tfjs-core</span></code>, <code class="docutils literal notranslate"><span class="pre">tfjs-data</span></code>, <code class="docutils literal notranslate"><span class="pre">tfjs-layers</span></code> 和 <code class="docutils literal notranslate"><span class="pre">tfjs-converter</span></code> 的輸出資訊，那麼就說明環境配置沒有問題了。</p>
<p>然後，在 JavaScript 程式中，通過以下指令，即可導入 TensorFlow.js：</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">tf</span> <span class="nx">from</span> <span class="s1">&#39;@tensorflow/tfjs&#39;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">tf</span><span class="p">.</span><span class="nx">version</span><span class="p">.</span><span class="nx">tfjs</span><span class="p">)</span>
<span class="c1">// Output: 1.3.1</span>
</pre></div>
</div>
<div class="admonition-import-javascript admonition">
<p class="admonition-title">使用 <cite>import</cite> 載入 JavaScript 模組</p>
<p><code class="docutils literal notranslate"><span class="pre">import</span></code> 是 JavaScript ES6 版本新開始擁有的新特性。粗略可以認為等同於 <code class="docutils literal notranslate"><span class="pre">require</span></code>。例如：<code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">*</span> <span class="pre">as</span> <span class="pre">tf</span> <span class="pre">from</span> <span class="pre">'&#64;tensorflow/tfjs'</span></code> 和 <code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">tf</span> <span class="pre">=</span> <span class="pre">require('&#64;tensorflow/tfjs')</span></code> 對上面的範例程式碼是相同的。希望了解更多的讀者，可以訪問 <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import">MDN 文件</a> 。</p>
</div>
</div>
<div class="section" id="id4">
<h3>在微信小程式中使用 TensorFlow.js<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h3>
<p>TensorFlow.js 微信小程式套件封裝了 TensorFlow.js 函式庫，用於提供給第三方程式呼叫。</p>
<p>在使用套件前，首先要在程式管理後台的“設置-第三方服務-套件管理”中添加套件。開發者可登入程式管理後台，通過 appid _wx6afed118d9e81df9_ 查找套件並添加。本套件無需申請，添加後可直接使用。</p>
<p>例子可以看 TFJS Mobilenet: <a class="reference external" href="https://github.com/tensorflow/tfjs-models/tree/master/mobilenet">物體辨識程式</a></p>
<p><a class="reference external" href="https://github.com/tensorflow/tfjs-wechat">TensorFlow.js 微信小程式官方文件位置</a></p>
<div class="admonition-tensorflow-js admonition">
<p class="admonition-title">TensorFlow.js 微信小程式教學</p>
<p>為了推動微信小程式中人工智能應用的發展，Google 專門為微信小程式打造了最新 TensorFlow.js 套件，並聯合 Google 認證機器學習專家、微信、騰訊課堂 NEXT 學院，聯合推出了“NEXT學院：TensorFlow.js 遇到程式” 課程，幫助程式開發者帶來更加易於上手和流暢的 TensorFlow.js 開發體驗。</p>
<p>上述課程主要介紹了如何將 TensorFlow.js 套件嵌入到微信小程式中，並基於其進行開發。課程中以一個姿態檢測的模型 PoseNet 作為範例，介紹了 TensorFlow.js 套件導入到微信小程式開發工具中，在項目開發中的配置，功能呼叫，載入模型等方法應用；此外，還介紹了在 Python 環境下訓練好的模型如何轉換並載入到程式中。</p>
<p>本章作者也參與了課程製作，課程中的案例簡單有趣易上手，通過學習，可以快速熟悉 TensorFlow.js 在程式中的開發和應用.有興趣的讀者可以前往 NEXT 學院，進行後續深度學習。</p>
<p>課程地址：<a class="reference external" href="https://ke.qq.com/course/428263">https://ke.qq.com/course/428263</a></p>
</div>
</div>
</div>
<div class="section" id="id7">
<h2>TensorFlow.js 模型部署<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h2>
<div class="section" id="python">
<h3>在瀏覽器中加載 Python 模型<a class="headerlink" href="#python" title="永久链接至标题">¶</a></h3>
<p>一般 TensorFlow 的模型，會被存儲為 SavedModel 格式。這也是 Google 目前推薦的模型保存最佳方式。SavedModel 格式可以通過 tensorflowjs-converter 轉換器轉換為可以直接被 TensorFlow.js 載入的格式，在 JavaScript 語言中進行使用。</p>
<ol class="arabic">
<li><p>安裝 <code class="docutils literal notranslate"><span class="pre">tensorflowjs_converter</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pip install tensorflowjs
</pre></div>
</div>
</li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">tensorflowjs_converter</span></code> 的使用細節，可以透過 <code class="docutils literal notranslate"><span class="pre">--help</span></code> 參數查看程式指令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tensorflowjs_converter --help
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>以下我們以 MobilenetV1 為例，看一下如何對模型文件進行轉換操作，並將可以被 TensorFlow.js 載入的模型文件，存放到 <code class="docutils literal notranslate"><span class="pre">/mobilenet/tfjs_model</span></code> 目錄下。</p></li>
</ol>
<p>轉換 SavedModel：將 <code class="docutils literal notranslate"><span class="pre">/mobilenet/saved_model</span></code> 轉換到 <code class="docutils literal notranslate"><span class="pre">/mobilenet/tfjs_model</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tensorflowjs_converter</span> \
    <span class="o">--</span><span class="n">input_format</span><span class="o">=</span><span class="n">tf_saved_model</span> \
    <span class="o">--</span><span class="n">output_node_names</span><span class="o">=</span><span class="s1">&#39;MobilenetV1/Predictions/Reshape_1&#39;</span> \
    <span class="o">--</span><span class="n">saved_model_tags</span><span class="o">=</span><span class="n">serve</span> \
    <span class="o">/</span><span class="n">mobilenet</span><span class="o">/</span><span class="n">saved_model</span> \
    <span class="o">/</span><span class="n">mobilenet</span><span class="o">/</span><span class="n">tfjs_model</span>
</pre></div>
</div>
<p>轉換完成的模型，保存成兩類文件：</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">model.json</span></code>：模型架構</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">group1-shard*of*</span></code>：模型參數</p></li>
</ul>
</div></blockquote>
<p>舉例來說，我們對 MobileNet v2 轉換出來的文件，如下：</p>
<blockquote>
<div><p>/mobilenet/tfjs_model/model.json
/mobilenet/tfjs_model/group1-shard1of5
…
/mobilenet/tfjs_model/group1-shard5of5</p>
</div></blockquote>
<ol class="arabic" start="3">
<li><p>為了加載轉換完成的模型文件，我們需要安裝 <code class="docutils literal notranslate"><span class="pre">tfjs-converter</span></code> 和 <code class="docutils literal notranslate"><span class="pre">&#64;tensorflow/tfjs</span></code> 套件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ npm install @tensorflow/tfjs
</pre></div>
</div>
</li>
<li><p>然後，我們就可以透過 JavaScript 來載入 TensorFlow 模型了！</p></li>
</ol>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">tf</span> <span class="nx">from</span> <span class="s1">&#39;@tensorflow/tfjs&#39;</span>

<span class="kr">const</span> <span class="nx">MODEL_URL</span> <span class="o">=</span> <span class="s1">&#39;/mobilenet/tfjs_model/model.json&#39;</span>

<span class="kr">const</span> <span class="nx">model</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">loadGraphModel</span><span class="p">(</span><span class="nx">MODEL_URL</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">cat</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">)</span>
<span class="nx">model</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="nx">tf</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">fromPixels</span><span class="p">(</span><span class="nx">cat</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition-tfhub admonition">
<p class="admonition-title">轉換 TFHub 模型</p>
<p>將 TFHub 模型 <code class="docutils literal notranslate"><span class="pre">https://tfhub.dev/google/imagenet/mobilenet_v1_100_224/classification/1</span></code> 轉換到 <code class="docutils literal notranslate"><span class="pre">/mobilenet/tfjs_model</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tensorflowjs_converter</span> \\
    <span class="o">--</span><span class="n">input_format</span><span class="o">=</span><span class="n">tf_hub</span> \\
    <span class="s1">&#39;https://tfhub.dev/google/imagenet/mobilenet_v1_100_224/classification/1&#39;</span> \\
    <span class="o">/</span><span class="n">mobilenet</span><span class="o">/</span><span class="n">tfjs_model</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="node-js-savedmodel">
<h3>在 Node.js 中執行原生 SavedModel 模型<a class="headerlink" href="#node-js-savedmodel" title="永久链接至标题">¶</a></h3>
<p>除了透過轉換工具 tfjs-converter 將 TensorFlow SavedModel、TFHub 模型或 Keras 模型轉換為 JavaScript 瀏覽器相容格式之外，如果我們在 Node.js 環境中執行，那麼還可以使用 TensorFlow C++ 的接口，直接執行原生的 SavedModel 模型。</p>
<p>在 TensorFlow.js 中執行原生的 SavedModel 模型非常簡單。我們只需要把預訓練的 TensorFlow 模型存為 SavedModel 格式，並透過 <code class="docutils literal notranslate"><span class="pre">&#64;tensorflow/tfjs-node</span></code> 或 <code class="docutils literal notranslate"><span class="pre">tfjs-node-gpu</span></code> 包將模型載入到 Node.js 進行推論即可，無需使用轉換工具 <code class="docutils literal notranslate"><span class="pre">tfjs-converter</span></code>。</p>
<p>預訓練的 TensorFlow SavedModel 可以透過一行程式碼在 JavaScript 中載入模型並用於推論：</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">model</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">loadSavedModel</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">output</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">predict</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span>
</pre></div>
</div>
<p>也可以將多個輸入以陣列或圖的形式提供給模型：</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">model1</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">loadSavedModel</span><span class="p">(</span><span class="nx">path1</span><span class="p">,</span> <span class="p">[</span><span class="nx">tag</span><span class="p">],</span> <span class="nx">signatureKey</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">outputArray</span> <span class="o">=</span> <span class="nx">model1</span><span class="p">.</span><span class="nx">predict</span><span class="p">([</span><span class="nx">inputTensor1</span><span class="p">,</span> <span class="nx">inputTensor2</span><span class="p">])</span>

<span class="kr">const</span> <span class="nx">model2</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">loadSavedModel</span><span class="p">(</span><span class="nx">path2</span><span class="p">,</span> <span class="p">[</span><span class="nx">tag</span><span class="p">],</span> <span class="nx">signatureKey</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">outputMap</span> <span class="o">=</span> <span class="nx">model2</span><span class="p">.</span><span class="nx">predict</span><span class="p">({</span><span class="nx">input1</span><span class="o">:</span> <span class="nx">inputTensor1</span><span class="p">,</span> <span class="nx">input2</span><span class="o">:</span><span class="nx">inputTensor2</span><span class="p">})</span>
</pre></div>
</div>
<p>此功能需要 <code class="docutils literal notranslate"><span class="pre">&#64;tensorflow/tfjs-node</span></code> 版本為 1.3.2 或更高，同時支持 CPU 和 GPU。它支援在 TensorFlow Python 1.x 和 2.0 版本中訓練和匯出的 TensorFlow SavedModel。這項功能帶來的好處除了無需進行任何轉換，原生執行 TensorFlow SavedModel 表示你可以在模型中使用 TensorFlow.js 尚未支援的運算子。這要透過將 SavedModel 作為 TensorFlow 會話載入到 C++ 中進行綁定得以實現。</p>
</div>
<div class="section" id="id8">
<h3>使用 TensorFlow.js 模型資料庫<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h3>
<p>TensorFlow.js 提供了一系列預訓練好的模型，方便大家快速的給自己的程式，加入人工智慧的能力。</p>
<p>模型庫 GitHub 網址：<a class="reference external" href="https://github.com/tensorflow/tfjs-models">https://github.com/tensorflow/tfjs-models</a>，其中模型分類包括圖像辨識、語音辨識、人體姿態辨識、物體辨識、文字分類等。</p>
<p>由於這些 API 預設模型文件都儲存在谷歌雲上，在程式內使用模型 API 時要提供 modelUrl 的參數，可以指向谷歌的伺服器。</p>
<p>谷歌雲的base url是 <a class="reference external" href="https://cloud.google.com/storage">https://cloud.google.com/storage</a>。以 posenet 模型為例：</p>
<ul class="simple">
<li><p>谷歌雲網址是：<a href="#id9"><span class="problematic" id="id10">**</span></a><a class="reference external" href="https://storage.googleapis.com/tfjs-models/savedmodel/posenet/mobilenet/float/050/model-stride16.json">https://storage.googleapis.com/tfjs-models/savedmodel/posenet/mobilenet/float/050/model-stride16.json</a></p></li>
</ul>
</div>
<div class="section" id="mobilenet">
<h3>在瀏覽器中使用 MobileNet 進行攝像頭物體辨識<a class="headerlink" href="#mobilenet" title="永久链接至标题">¶</a></h3>
<p>這裡我們透過一個簡單的 HTML 頁面，來呼叫 TensorFlow.js 和與訓練好的 MobileNet ，在用戶的瀏覽器中，通過攝像頭來辨識圖像中的物體是什麼。</p>
<ol class="arabic simple">
<li><p>我們建立一個 HTML 文件，在表頭資訊中，通過將 NPM 模組轉換為線上可以引用的免費服務 <code class="docutils literal notranslate"><span class="pre">unpkg.com</span></code>，來載入 <code class="docutils literal notranslate"><span class="pre">&#64;tensorflow/tfjs</span></code> 和 <code class="docutils literal notranslate"><span class="pre">&#64;tensorflow-models/mobilenet</span></code> 兩個 TFJS 模塊：</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://unpkg.com/@tensorflow/tfjs&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://unpkg.com/@tensorflow-models/mobilenet&quot;</span><span class="o">&gt;</span> <span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>我們宣告三個 HTML 元素：用來顯示視頻的 <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code>，用來顯示我們截取特定影像的 <code class="docutils literal notranslate"><span class="pre">&lt;img&gt;</span></code>，和用來顯示檢測文字結果的 <code class="docutils literal notranslate"><span class="pre">&lt;p&gt;</span></code>：</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">video</span> <span class="n">width</span><span class="o">=</span><span class="mi">400</span> <span class="n">height</span><span class="o">=</span><span class="mi">300</span><span class="o">&gt;&lt;/</span><span class="n">video</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">img</span> <span class="n">width</span><span class="o">=</span><span class="mi">400</span> <span class="n">height</span><span class="o">=</span><span class="mi">300</span> <span class="o">/&gt;</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>我們透過 JavaScript ，將對應的 HTML 元素進行初始化：<code class="docutils literal notranslate"><span class="pre">video</span></code>, <code class="docutils literal notranslate"><span class="pre">image</span></code>, <code class="docutils literal notranslate"><span class="pre">status</span></code> 三個變數分別用來對應 <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;img&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;p&gt;</span></code> 三個 HTML 元素，<code class="docutils literal notranslate"><span class="pre">canvas</span></code> 和 <code class="docutils literal notranslate"><span class="pre">ctx</span></code> 用來做從相機獲取影像資料的暫時儲存位置。<code class="docutils literal notranslate"><span class="pre">model</span></code> 將用來儲存我們從網路上載入的 MobileNet模型：</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">const</span> <span class="n">video</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;video&#39;</span><span class="p">)</span>
    <span class="n">const</span> <span class="n">image</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">)</span>
    <span class="n">const</span> <span class="n">status</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>

    <span class="n">const</span> <span class="n">canvas</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">)</span>
    <span class="n">const</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">)</span>

    <span class="n">let</span> <span class="n">model</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p><code class="docutils literal notranslate"><span class="pre">main()</span></code> 用來初始化整個系統，完成載入 MobileNet 模型，將用戶相機的資料綁定 <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> 這個 HTML 元素上，最後觸發 <code class="docutils literal notranslate"><span class="pre">refresh()</span></code> 函數來定期刷新畫面：</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">async</span> <span class="n">function</span> <span class="n">main</span> <span class="p">()</span> <span class="p">{</span>
        <span class="n">status</span><span class="o">.</span><span class="n">innerText</span> <span class="o">=</span> <span class="s2">&quot;Model loading...&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mobilenet</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">status</span><span class="o">.</span><span class="n">innerText</span> <span class="o">=</span> <span class="s2">&quot;Model is loaded!&quot;</span>

        <span class="n">const</span> <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">navigator</span><span class="o">.</span><span class="n">mediaDevices</span><span class="o">.</span><span class="n">getUserMedia</span><span class="p">({</span> <span class="n">video</span><span class="p">:</span> <span class="n">true</span> <span class="p">})</span>
        <span class="n">video</span><span class="o">.</span><span class="n">srcObject</span> <span class="o">=</span> <span class="n">stream</span>
        <span class="k">await</span> <span class="n">video</span><span class="o">.</span><span class="n">play</span><span class="p">()</span>
        
        <span class="n">canvas</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">videoWidth</span>
        <span class="n">canvas</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">videoHeight</span>

        <span class="n">refresh</span><span class="p">()</span>
    <span class="p">}</span>
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p><code class="docutils literal notranslate"><span class="pre">refresh()</span></code> 函數，用來從影片中取出當前的影像資訊，然後透過 MobileNet 模型進行分類，並將分類結果，顯示在網頁上。然後，透過 <code class="docutils literal notranslate"><span class="pre">setTimeout</span></code>，重複執行自己，來完成持續對影像資料進行處理的功能：</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">async</span> <span class="n">function</span> <span class="n">refresh</span><span class="p">(){</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">drawImage</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">image</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">toDataURL</span><span class="p">(</span><span class="s1">&#39;image/png&#39;</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="n">model</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">const</span> <span class="n">predictions</span> <span class="o">=</span> <span class="k">await</span> <span class="n">model</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        
        <span class="n">const</span> <span class="n">className</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">className</span>
        <span class="n">const</span> <span class="n">percentage</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">probability</span><span class="p">)</span>
        
        <span class="n">status</span><span class="o">.</span><span class="n">innerHTML</span> <span class="o">=</span> <span class="n">percentage</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">className</span>
        
        <span class="n">setTimeout</span><span class="p">(</span><span class="n">refresh</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>整體功能，只需要一個文件，幾十行 HTML/JavaScript 程式碼即可實現。可以直接在瀏覽器中執行，完整的 HTML 程式碼如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://unpkg.com/@tensorflow/tfjs&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://unpkg.com/@tensorflow-models/mobilenet&quot;</span><span class="o">&gt;</span> <span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">video</span> <span class="n">width</span><span class="o">=</span><span class="mi">400</span> <span class="n">height</span><span class="o">=</span><span class="mi">300</span><span class="o">&gt;&lt;/</span><span class="n">video</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">img</span> <span class="n">width</span><span class="o">=</span><span class="mi">400</span> <span class="n">height</span><span class="o">=</span><span class="mi">300</span> <span class="o">/&gt;</span>

<span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
    <span class="n">const</span> <span class="n">video</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;video&#39;</span><span class="p">)</span>
    <span class="n">const</span> <span class="n">image</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">)</span>
    <span class="n">const</span> <span class="n">status</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>

    <span class="n">const</span> <span class="n">canvas</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">)</span>
    <span class="n">const</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">)</span>

    <span class="n">let</span> <span class="n">model</span>

    <span class="n">main</span><span class="p">()</span>

    <span class="k">async</span> <span class="n">function</span> <span class="n">main</span> <span class="p">()</span> <span class="p">{</span>
        <span class="n">status</span><span class="o">.</span><span class="n">innerText</span> <span class="o">=</span> <span class="s2">&quot;Model loading...&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mobilenet</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">status</span><span class="o">.</span><span class="n">innerText</span> <span class="o">=</span> <span class="s2">&quot;Model is loaded!&quot;</span>

        <span class="n">const</span> <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">navigator</span><span class="o">.</span><span class="n">mediaDevices</span><span class="o">.</span><span class="n">getUserMedia</span><span class="p">({</span> <span class="n">video</span><span class="p">:</span> <span class="n">true</span> <span class="p">})</span>
        <span class="n">video</span><span class="o">.</span><span class="n">srcObject</span> <span class="o">=</span> <span class="n">stream</span>
        <span class="k">await</span> <span class="n">video</span><span class="o">.</span><span class="n">play</span><span class="p">()</span>
        
        <span class="n">canvas</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">videoWidth</span>
        <span class="n">canvas</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">videoHeight</span>

        <span class="n">refresh</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">async</span> <span class="n">function</span> <span class="n">refresh</span><span class="p">(){</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">drawImage</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">image</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">toDataURL</span><span class="p">(</span><span class="s1">&#39;image/png&#39;</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="n">model</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">const</span> <span class="n">predictions</span> <span class="o">=</span> <span class="k">await</span> <span class="n">model</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        
        <span class="n">const</span> <span class="n">className</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">className</span>
        <span class="n">const</span> <span class="n">percentage</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">probability</span><span class="p">)</span>
        
        <span class="n">status</span><span class="o">.</span><span class="n">innerHTML</span> <span class="o">=</span> <span class="n">percentage</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">className</span>
        
        <span class="n">setTimeout</span><span class="p">(</span><span class="n">refresh</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="p">}</span>

<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>

<span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>執行效果截圖如下。可以看到水杯被辨識為 “beer glass” 啤酒杯的機率是 90% ：</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/mobilenet.png"><img alt="../../_images/mobilenet.png" src="../../_images/mobilenet.png" style="width: 60%;" /></a>
</div>
</div>
</div>
<div class="section" id="id11">
<h2>TensorFlow.js 模型訓練 *<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h2>
<p>與 TensorFlow Serving 和 TensorFlow Lite 不同，TensorFlow.js 不僅支援模型的部署和推斷，還支援直接在 TensorFlow.js 中進行模型訓練、</p>
<p>在 TensorFlow 基礎章節中，我們已經用 Python 實作過，針對某城市在 2013-2017 年房價預測的任務，透過對該資料進行線性回歸，即使用線性模型 <img class="math" src="../../_images/math/08657936072cefe083681bc78c8c9bcda2c86e2d.png" alt="y = ax + b"/> 來擬合上述資料，此處 <img class="math" src="../../_images/math/c13eacc8d78956859939555ea65552aa2f4f15a5.png" alt="a"/> 和 <img class="math" src="../../_images/math/3de2ed824326dc0eb383a42dd6ec44d3b401047b.png" alt="b"/> 是待求的參數。</p>
<p>下面我們改用 TensorFlow.js 來實作一個 JavaScript 版本。</p>
<p>首先，我們定義資料，進行基本的正規化操作。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">const</span> <span class="n">xsRaw</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">2014</span><span class="p">,</span> <span class="mi">2015</span><span class="p">,</span> <span class="mi">2016</span><span class="p">,</span> <span class="mi">2017</span><span class="p">])</span>
    <span class="n">const</span> <span class="n">ysRaw</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">12000</span><span class="p">,</span> <span class="mi">14000</span><span class="p">,</span> <span class="mi">15000</span><span class="p">,</span> <span class="mi">16500</span><span class="p">,</span> <span class="mi">17500</span><span class="p">])</span>

    <span class="o">//</span> <span class="n">归一化</span>
    <span class="n">const</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">xsRaw</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">xsRaw</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">xsRaw</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">xsRaw</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
    <span class="n">const</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">ysRaw</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ysRaw</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">ysRaw</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ysRaw</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
</pre></div>
</div>
<p>接下來，我們來計算線性模型中兩個參數 <code class="docutils literal notranslate"><span class="pre">a</span></code> 和 <code class="docutils literal notranslate"><span class="pre">b</span></code> 的值。</p>
<p>使用 <code class="docutils literal notranslate"><span class="pre">loss()</span></code> 計算損失；
使用 <code class="docutils literal notranslate"><span class="pre">optimizer.minimize()</span></code> 自動更新模型參數。</p>
<div class="admonition-javascript-fat-arrow-function admonition">
<p class="admonition-title">JavaScript 中的胖箭頭函數（Fat Arrow Function）</p>
<p>從 JavaScript 的 ES6 版本開始，允許使用箭頭函數（<code class="docutils literal notranslate"><span class="pre">=&gt;</span></code>）來簡化函數的宣告和書寫，類似於 Python 中的 lambda 表達式。例如，以下箭頭函數：</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">sum</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span>
<span class="p">}</span>
</pre></div>
</div>
<p>在效果上等同於如下的傳統函數：</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">sum</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span>
<span class="p">}</span>
</pre></div>
</div>
<p>不過箭頭函數中沒有自己的 <code class="docutils literal notranslate"><span class="pre">this</span></code> 和 <code class="docutils literal notranslate"><span class="pre">arguments</span></code>，不可以被當做構造函數（<code class="docutils literal notranslate"><span class="pre">new</span></code>），也不可以被當做 <code class="docutils literal notranslate"><span class="pre">Generator</span></code> （無法使用 <code class="docutils literal notranslate"><span class="pre">yield</span></code>）。感興趣的讀者可以參考 <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions">MDN 文件</a> 以了解更多。</p>
</div>
<div class="admonition-tensorflow-js-datasync admonition">
<p class="admonition-title">TensorFlow.js 中的 <cite>dataSync()</cite> 系列資料同步函數</p>
<p>它的作用是把 Tensor 資料從 GPU 中取回來，可以理解為與 Python 中的 <cite>.numpy()</cite> 功能相當，即將資料取回，供本機顯示，或本機計算使用。感興趣的讀者可以參考 <a class="reference external" href="https://js.tensorflow.org/api/latest/#tf.Tensor.dataSync">TensorFlow.js 文檔</a> 以瞭解更多。</p>
</div>
<div class="admonition-tensorflow-js-sub admonition">
<p class="admonition-title">TensorFlow.js 中的 <cite>sub()</cite> 系列數學計算函數</p>
<p>TensorFlow.js 支援 <cite>tf.sub(a, b)</cite> 和 <cite>a.sub(b)</cite> 兩種方法的數學函數呼叫。其效果是相同的，讀者可以根據自己的喜好來選擇。感興趣的讀者可以參考 <a class="reference external" href="https://js.tensorflow.org/api/latest/#sub">TensorFlow.js 文檔</a> 以了解更多。</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    const a = tf.scalar(Math.random()).variable()
    const b = tf.scalar(Math.random()).variable()

    // y = a * x + b.
    const f = (x) =&gt; a.mul(x).add(b)
    const loss = (pred, label) =&gt; pred.sub(label).square().mean()

    const learningRate = 1e-3
    const optimizer = tf.train.sgd(learningRate)

    // 训练模型
    for (let i = 0; i &lt; 10000; i++) {
        optimizer.minimize(() =&gt; loss(f(xs), ys))
    }

    // 预测
    console.log(`a: ${a.dataSync()}, b: ${b.dataSync()}`)
    const preds = f(xs).dataSync()
    const trues = ys.arraySync()
    preds.forEach((pred, i) =&gt; {
        console.log(`x: ${i}, pred: ${pred.toFixed(2)}, true: ${trues[i].toFixed(2)}`)
    })
</pre></div>
</div>
<p>從下面的輸出範例中我們可以看到，已經擬合得比較接近了。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="p">:</span> <span class="mf">0.9339302778244019</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="mf">0.08108722418546677</span>
<span class="n">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span> <span class="n">true</span><span class="p">:</span> <span class="mf">0.00</span>
<span class="n">x</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="mf">0.31</span><span class="p">,</span> <span class="n">true</span><span class="p">:</span> <span class="mf">0.36</span>
<span class="n">x</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="mf">0.55</span><span class="p">,</span> <span class="n">true</span><span class="p">:</span> <span class="mf">0.55</span>
<span class="n">x</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="mf">0.78</span><span class="p">,</span> <span class="n">true</span><span class="p">:</span> <span class="mf">0.82</span>
<span class="n">x</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="mf">1.02</span><span class="p">,</span> <span class="n">true</span><span class="p">:</span> <span class="mf">1.00</span>
</pre></div>
</div>
<p>可以直接在瀏覽器中執行，完整的 HTML 程式碼如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;html&gt;
&lt;head&gt;
    &lt;script src=&quot;http://unpkg.com/@tensorflow/tfjs/dist/tf.min.js&quot;&gt;&lt;/script&gt;
    &lt;script&gt;
    const xsRaw = tf.tensor([2013, 2014, 2015, 2016, 2017])
    const ysRaw = tf.tensor([12000, 14000, 15000, 16500, 17500])

    // 归一化
    const xs = xsRaw.sub(xsRaw.min())
                    .div(xsRaw.max().sub(xsRaw.min()))
    const ys = ysRaw.sub(ysRaw.min())
                    .div(ysRaw.max().sub(ysRaw.min()))

    const a = tf.scalar(Math.random()).variable()
    const b = tf.scalar(Math.random()).variable()

    // y = a * x + b.
    const f = (x) =&gt; a.mul(x).add(b)
    const loss = (pred, label) =&gt; pred.sub(label).square().mean()

    const learningRate = 1e-3
    const optimizer = tf.train.sgd(learningRate)

    // 训练模型
    for (let i = 0; i &lt; 10000; i++) {
        optimizer.minimize(() =&gt; loss(f(xs), ys))
    }

    // 预测
    console.log(`a: ${a.dataSync()}, b: ${b.dataSync()}`)
    const preds = f(xs).dataSync()
    const trues = ys.arraySync()
    preds.forEach((pred, i) =&gt; {
        console.log(`x: ${i}, pred: ${pred.toFixed(2)}, true: ${trues[i].toFixed(2)}`)
    })
    &lt;/script&gt;
&lt;/head&gt;
&lt;/html&gt;
</pre></div>
</div>
<div class="section" id="id15">
<h3>TensorFlow.js 性能對比<a class="headerlink" href="#id15" title="永久链接至标题">¶</a></h3>
<p>關於 TensorFlow.js 的性能，Google 官方做了一份基於 MobileNet 的評測，可以作為參考。具體評測是基於 MobileNet 的 TensorFlow 模型，將其 JavaScript 版本和 Python 版本各執行兩百次，其評測結論如下。</p>
<p>手機瀏覽器性能：（單位：毫秒 ms）</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/performance-mobile.png"><img alt="../../_images/performance-mobile.png" src="../../_images/performance-mobile.png" style="width: 60%;" /></a>
</div>
<p>TensorFlow.js 在手機瀏覽器中執行一次推論：</p>
<ul class="simple">
<li><p>在 iPhoneX 上需要時間為 22ms</p></li>
<li><p>在 Pixel3 上需要時間為 100ms</p></li>
</ul>
<p>與 TensorFlow Lite 程式碼基準相比，手機瀏覽器中的 TensorFlow.js 在 IPhoneX 上的執行時間為基準的1.2倍，在 Pixel3 上執行的時間為基準的 1.8 倍。</p>
<p>瀏覽器性能：（單位：毫秒 ms）</p>
<p>在瀏覽器中，TensorFlow.js 可以使用 WebGL 進行硬體加速，將 GPU 資源使用起來。</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/performance-browser.png"><img alt="../../_images/performance-browser.png" src="../../_images/performance-browser.png" style="width: 60%;" /></a>
</div>
<p>TensorFlow.js 在瀏覽器中執行一次推論：</p>
<ul class="simple">
<li><p>在 CPU 上需要時間為 97ms</p></li>
<li><p>在 GPU (WebGL) 上需要時間為 10ms</p></li>
</ul>
<p>與 Python 程式碼基準相比，瀏覽器中的 TensorFlow.js 在 CPU 上的執行時間為基準的 1.7 倍，在 GPU (WebGL) 上執行的時間為基準的 3.8 倍。</p>
<p>Node.js 性能：</p>
<p>在 Node.js 中，TensorFlow.js 可以用 JavaScript 載入轉換後模型，或使用 TensorFlow 的 C++ Binding ，分別接近和超越了 Python 的性能。</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/performance-node.png"><img alt="../../_images/performance-node.png" src="../../_images/performance-node.png" style="width: 60%;" /></a>
</div>
<p>TensorFlow.js 在 Node.js 執行一次推論：</p>
<ul class="simple">
<li><p>在 CPU 上執行原生模型時間為 19.6ms</p></li>
<li><p>在 GPU (CUDA) 上執行原生模型時間為 7.68ms</p></li>
</ul>
<p>與 Python 程式碼基準相比，Node.js 的 TensorFlow.js 在 CPU 和 GPU 上的執行時間都比基準快 4% 。</p>
<script>
    $(document).ready(function(){
        $(".rst-footer-buttons").after("<div id='discourse-comments'></div>");
        DiscourseEmbed = { discourseUrl: 'https://discuss.tf.wiki/', topicId: 195 };
        (function() {
            var d = document.createElement('script'); d.type = 'text/javascript'; d.async = true;
            d.src = DiscourseEmbed.discourseUrl + 'javascripts/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
        })();
    });
</script></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../appendix/distributed.html" class="btn btn-neutral float-right" title="TensorFlow分布式訓練" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="lite.html" class="btn btn-neutral float-left" title="TensorFlow Lite（Jinpeng）" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2021, Xihan Li (snowkylin)

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

  <p><a href="https://beian.miit.gov.cn/" target="_blank">沪ICP备13038357号-18</a ></p> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-40509304-12', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>